<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Sistema di Prenotazioni Campi da Tennis</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #calendar { max-width: 900px; margin: 40px auto; }
    form { margin: 20px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Sistema di Prenotazioni Campi da Tennis</h1>

  <h2>Nuova Prenotazione</h2>
  <form id="bookingForm">
    <label>Nome Giocatore:
      <input type="text" id="user" required>
    </label>
    <label>Campo:
      <select id="court">
        {% for court in courts %}
          <option value="{{ court }}">{{ court }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Data e Ora Inizio:
      <input type="datetime-local" id="start" required>
    </label>
    <label>Durata:
      <select id="duration">
        {% for d in durations %}
          <option value="{{ d }}">{{ d }} minuti</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">Prenota</button>
  </form>

  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let calendarEl = document.getElementById('calendar');
      let bookings = JSON.parse('{{ bookings_json | safe }}');

      let calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        selectable: true,
        slotMinTime: "{{ open_time }}",
        slotMaxTime: "{{ close_time }}",
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridDay,timeGridWeek,dayGridMonth'
        },
        events: bookings.map(b => ({
          title: b.user + " (" + b.court + ")",
          start: b.start,
          end: b.end
        })),
        select: function(info) {
          // Compila la data di inizio
          document.getElementById('start').value = info.startStr.substring(0,16);

          // Calcola durata in minuti dall'intervallo selezionato
          let diffMs = new Date(info.end) - new Date(info.start);
          let diffMinutes = diffMs / 60000;

          // Imposta il valore della durata nel menu a tendina (se esiste come opzione)
          let durationSelect = document.getElementById('duration');
          let option = Array.from(durationSelect.options).find(o => parseInt(o.value) === diffMinutes);

          if (option) {
            durationSelect.value = diffMinutes;
          } else {
            // Se la durata non Ã¨ presente tra le opzioni, la aggiunge
            let newOption = document.createElement('option');
            newOption.value = diffMinutes;
            newOption.text = diffMinutes + " minuti";
            durationSelect.appendChild(newOption);
            durationSelect.value = diffMinutes;
          }
        },
        datesSet: function(info) {
          // Aggiorna il titolo includendo il campo selezionato
          let court = document.getElementById('court').value;
          let titleEl = calendarEl.querySelector('.fc-toolbar-title');
          if (titleEl) {
            titleEl.innerText = court + ": " + info.view.title;
          }
        }
      });

      calendar.render();

      // Aggiorna il titolo quando cambio campo dal menu
      document.getElementById('court').addEventListener('change', function() {
        let view = calendar.view;
        let titleEl = calendarEl.querySelector('.fc-toolbar-title');
        if (titleEl) {
          titleEl.innerText = this.value + ": " + view.title;
        }
      });

      // Gestione form prenotazione
      document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        let user = document.getElementById('user').value;
        let court = document.getElementById('court').value;
        let start = document.getElementById('start').value;
        let duration = document.getElementById('duration').value;

        let res = await fetch("/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user, court, start, duration })
        });

        let data = await res.json();
        if (data.status === "ok") {
          alert("Prenotazione confermata!");
          location.reload();
        } else {
          alert("Errore: " + data.message);
        }
      });
    });
  </script>
</body>
</html>
