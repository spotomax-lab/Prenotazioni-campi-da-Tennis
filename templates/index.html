<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Sistema di Prenotazioni Campi da Tennis</title>

  <!-- FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.min.css' rel='stylesheet' />

  <!-- FullCalendar JS -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/main.min.js'></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { margin-bottom: 10px; }
    #calendar { max-width: 900px; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>Sistema di Prenotazioni Campi da Tennis</h1>

  <h2>Orari di Apertura</h2>
  <p>Dal: {{ open_time }} | Al: {{ close_time }}</p>

  <h2>Campi Disponibili</h2>
  <ul>
    {% for court in courts %}
      <li>{{ court }}</li>
    {% endfor %}
  </ul>

  <h2>Durate Consentite</h2>
  <ul>
    {% for duration in durations %}
      <li>{{ duration }} minuti</li>
    {% endfor %}
  </ul>

  <!-- Calendario -->
  <div id="calendar"></div>

  <script>
    const bookings = {{ bookings | safe }};
    const courts = {{ courts | safe }};
    const durations = {{ durations | safe }};

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        slotDuration: '01:00:00',
        allDaySlot: false,
        expandRows: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridWeek,timeGridDay'
        },
        events: bookings,
        selectable: true,
        select: function(info) {
          // Scelta campo
          let court = prompt("Seleziona campo:\n" + courts.join("\n"));
          if (!court || !courts.includes(court)) {
            alert("Campo non valido!");
            return;
          }

          // Scelta durata
          let duration = prompt("Seleziona durata (minuti):\n" + durations.join("\n"));
          duration = parseInt(duration);
          if (!durations.includes(duration)) {
            alert("Durata non valida!");
            return;
          }

          // Calcolo ora di fine
          let start = info.start;
          let end = new Date(start.getTime() + duration*60000);

          // Invia prenotazione al server
          fetch("/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: court + " - Prenotato",
              start: start.toISOString(),
              end: end.toISOString()
            })
          }).then(response => {
            if (response.ok) {
              alert("Prenotazione registrata!");
              calendar.addEvent({
                title: court + " - Prenotato",
                start: start,
                end: end
              });
            } else {
              alert("Errore nella prenotazione.");
            }
          });
        }
      });
      calendar.render();
    });
  </script>
</body>
</html>
