<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Prenotazioni Campi da Tennis</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #calendar { max-width: 900px; margin: 40px auto; }
    .form-container { max-width: 500px; margin: 20px auto; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    label { display: block; margin-top: 10px; }
    button { margin-top: 15px; padding: 8px 15px; }
  </style>
</head>
<body>
  <h1>Sistema di Prenotazioni Campi da Tennis</h1>

  <h3>Orari di Apertura</h3>
  <p>Dal: {{ open_time }} | Al: {{ close_time }}</p>

  <div class="form-container">
    <h3>Nuova Prenotazione</h3>
    <form id="bookingForm">
      <label>Campo:
        <select id="court">
          {% for court in courts %}
            <option value="{{ court }}">{{ court }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Data e Ora Inizio:
        <input type="datetime-local" id="start" required>
      </label>

      <label>Durata:
        <select id="duration">
          {% for d in durations %}
            <option value="{{ d }}">{{ d }} minuti</option>
          {% endfor %}
        </select>
      </label>

      <button type="submit">Prenota</button>
    </form>
  </div>

  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'it',
        slotMinTime: '{{ open_time }}',
        slotMaxTime: '{{ close_time }}',
        events: [
          {% for court, slots in bookings.items() %}
            {% for start in slots %}
              {
                title: '{{ court }}',
                start: '{{ start }}'
              },
            {% endfor %}
          {% endfor %}
        ]
      });

      calendar.render();

      // Gestione form di prenotazione
      document.getElementById("bookingForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const court = document.getElementById("court").value;
        const start = document.getElementById("start").value;
        const duration = document.getElementById("duration").value;

        const response = await fetch("/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ court, start, duration })
        });

        const result = await response.json();

        if (response.status === 200 && result.status === "ok") {
          alert("Prenotazione effettuata con successo!");
          location.reload();
        } else if (response.status === 409) {
          alert("Errore: slot gi√† prenotato!");
        } else {
          alert("Errore imprevisto, riprova.");
        }
      });
    });
  </script>
</body>
</html>
