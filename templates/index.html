<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Sistema di Prenotazioni Campi da Tennis</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #calendar { max-width: 900px; margin: 40px auto; }
    form { margin: 20px 0; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Sistema di Prenotazioni Campi da Tennis</h1>

  <div id="calendar"></div>

  <h2>Nuova Prenotazione</h2>
  <form id="bookingForm">
    <label>Nome Giocatore:
      <input type="text" id="user" required>
    </label>
    <label>Campo:
      <select id="court">
        {% for court in courts %}
          <option value="{{ court }}">{{ court }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Data e Ora Inizio:
      <input type="datetime-local" id="start" required>
    </label>
    <label>Durata:
      <select id="duration">
        {% for d in durations %}
          <option value="{{ d }}">{{ d }} minuti</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">Prenota</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let calendarEl = document.getElementById('calendar');
      let bookings = JSON.parse('{{ bookings_json | safe }}');

      let calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        slotMinTime: "{{ open_time }}",
        slotMaxTime: "{{ close_time }}",
        events: bookings.map(b => ({
          title: b.user + " (" + b.court + ")",
          start: b.start,
          end: b.end
        }))
      });

      calendar.render();

      // Gestione form prenotazione
      document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        let user = document.getElementById('user').value;
        let court = document.getElementById('court').value;
        let start = document.getElementById('start').value;
        let duration = document.getElementById('duration').value;

        let res = await fetch("/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user, court, start, duration })
        });

        let data = await res.json();
        if (data.status === "ok") {
          alert("Prenotazione confermata!");
          location.reload();
        } else {
          alert("Errore: " + data.message);
        }
      });
    });
  </script>
</body>
</html>
